name: Publish MVI Docs

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "owner/name of the repo to publish to (overrides secrets.PUBLISH_REPO)"
        required: false
        type: string
      target_branch:
        description: "Branch to push docs to (overrides secrets.PUBLISH_BRANCH)"
        required: false
        type: string
      dest_dir:
        description: "Destination directory in target repo (overrides secrets.PUBLISH_PATH)"
        required: false
        type: string
  push:
    paths:
      - 'libs/mvi/**'
    branches:
      - main
      - master

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    env:
      TARGET_REPO: ${{ inputs.target_repo || secrets.PUBLISH_REPO }}
      TARGET_BRANCH: ${{ inputs.target_branch || secrets.PUBLISH_BRANCH }}
      DEST_DIR: ${{ inputs.dest_dir || secrets.PUBLISH_PATH || 'mvi-docs' }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build MVI and generate Dokka HTML
        run: ./gradlew --no-daemon :libs:mvi:build :libs:mvi:mviDokkaHtml

      - name: Prepare docs artifact
        run: |
          rm -rf publish-docs
          mkdir -p publish-docs
          cp -R libs/mvi/docs/* publish-docs/

      - name: Checkout target repo
        if: env.TARGET_REPO != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PUBLISH_TOKEN }}
          path: target-repo
          fetch-depth: 0

      - name: Copy docs into target repo
        if: env.TARGET_REPO != ''
        run: |
          mkdir -p "target-repo/${DEST_DIR}"
          rsync -av --delete publish-docs/ "target-repo/${DEST_DIR}/"

      - name: Commit and push
        if: env.TARGET_REPO != ''
        working-directory: target-repo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish MVI docs from ${GITHUB_REPOSITORY}@${GITHUB_SHA}"
            git push origin "HEAD:${TARGET_BRANCH:-gh-pages}"
          fi
